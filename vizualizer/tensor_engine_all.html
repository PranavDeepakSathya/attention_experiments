<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Tensor Voxel Engine</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0a0a0a; color: white; font-family: monospace; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(0,0,0,0.8); padding: 15px; border: 1px solid #333; border-radius: 8px; pointer-events: none; }
        .label { font-size: 14px; color: #aaa; margin-bottom: 5px; }

        #labels-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; overflow: hidden; }

        /* Main Tensor Titles */
        .tensor-label { position: absolute; color: white; background: rgba(0,0,0,0.6); padding: 4px 8px; border: 1px solid #555; border-radius: 4px; font-weight: bold; font-size: 14px; transform: translate(-50%, -50%); transition: opacity 0.1s; }

        /* Canonical Axis Labels */
        .axis-label { position: absolute; font-size: 14px; font-weight: bold; transform: translate(-50%, -50%); transition: opacity 0.1s; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>Attention Slice Footprint</h2>
        <div class="label" style="color:#ff8888;">Red Arrow: Width (X)</div>
        <div class="label" style="color:#88ff88;">Green Arrow: Height (Y)</div>
        <div class="label" style="color:#8888ff;">Blue Arrow: Depth (Z)</div>
    </div>

    <div id="labels-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        const tensorData = {"Q": {"shape": [2, 16, 4], "hits": [[[true, true, true, true], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false]], [[false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false]]], "color": 61695, "dims": ["B", "L_q", "D"]}, "K": {"shape": [2, 4, 16], "hits": [[[true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true], [true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true], [true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true], [true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true]], [[false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]]], "color": 16711765, "dims": ["B", "D", "L_k"]}, "S": {"shape": [2, 16, 16], "hits": [[[true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]], [[false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]]], "color": 12320512, "dims": ["B", "L_q", "L_k"]}, "P": {"shape": [2, 16, 16], "hits": [[[true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]], [[false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false], [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]]], "color": 12320512, "dims": ["B", "L_q", "L_k"]}, "V": {"shape": [2, 16, 4], "hits": [[[true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false]], [[false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false]]], "color": 16755200, "dims": ["B", "L_k", "D"]}, "O": {"shape": [2, 16, 4], "hits": [[[true, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false]], [[false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false], [false, false, false, false]]], "color": 11534591, "dims": ["B", "L_q", "D"]}};

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        let maxDim = 0;
        for(const name in tensorData) {
            const shape = tensorData[name].shape;
            maxDim = Math.max(maxDim, shape[0], shape[1], shape[2]);
        }

        const spacingX = maxDim * 1.1; 
        const spacingZ = maxDim * 1.8;

        // Linear layout on the same plane
        const layout = {
            'Q': { x: 0, z: 0 }, 
            'K': { x: 1, z: 0 }, 
            'S': { x: 2, z: 0 },
            'P': { x: 3, z: 0 }, 
            'V': { x: 4, z: 0 }, 
            'O': { x: 5, z: 0 }
        };

        const labelMarkers = [];
        const labelsContainer = document.getElementById('labels-container');

        function addTrackingLabel(text, color, localPos, parentGroup, className) {
            const el = document.createElement('div');
            el.className = className;
            el.style.color = color;
            el.innerText = text;
            labelsContainer.appendChild(el);

            const markerObj = new THREE.Object3D();
            markerObj.position.copy(localPos);
            parentGroup.add(markerObj);

            labelMarkers.push({ element: el, obj: markerObj });
        }

        const boxGeo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const edgeGeo = new THREE.EdgesGeometry(boxGeo);

        const wireMat = new THREE.LineBasicMaterial({ color: 0x666666, transparent: true, opacity: 0.6 });
        const outlineMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.9 });

        for(const [name, pos] of Object.entries(layout)) {
            const data = tensorData[name];
            const [A, B, C] = data.shape;
            const hitMat = new THREE.MeshBasicMaterial({ color: data.color, transparent: true, opacity: 0.9 });

            const group = new THREE.Group();

            for(let a=0; a<A; a++) {
                for(let b=0; b<B; b++) {
                    for(let c=0; c<C; c++) {
                        const isHit = data.hits[a][b][c];
                        const posX = c;             
                        const posY = -b;            
                        const posZ = a;             

                        if(isHit) {
                            const mesh = new THREE.Mesh(boxGeo, hitMat);
                            mesh.position.set(posX, posY, posZ);
                            group.add(mesh);

                            const edges = new THREE.LineSegments(edgeGeo, outlineMat);
                            edges.position.set(posX, posY, posZ);
                            group.add(edges);
                        } else {
                            const wire = new THREE.LineSegments(edgeGeo, wireMat);
                            wire.position.set(posX, posY, posZ);
                            group.add(wire);
                        }
                    }
                }
            }

            const axisOrigin = new THREE.Vector3(-0.6, 0.6, -0.6);

            const dirX = new THREE.Vector3(1, 0, 0);
            const lenX = C + 0.5;
            group.add(new THREE.ArrowHelper(dirX, axisOrigin, lenX, 0xff5555, 0.4, 0.2));
            addTrackingLabel(data.dims[2], '#ff8888', new THREE.Vector3(lenX, 0, 0).add(axisOrigin), group, 'axis-label');

            const dirY = new THREE.Vector3(0, -1, 0);
            const lenY = B + 0.5;
            group.add(new THREE.ArrowHelper(dirY, axisOrigin, lenY, 0x55ff55, 0.4, 0.2));
            addTrackingLabel(data.dims[1], '#88ff88', new THREE.Vector3(0, -lenY, 0).add(axisOrigin), group, 'axis-label');

            const dirZ = new THREE.Vector3(0, 0, 1);
            const lenZ = A + 0.5;
            group.add(new THREE.ArrowHelper(dirZ, axisOrigin, lenZ, 0x5555ff, 0.4, 0.2));
            addTrackingLabel(data.dims[0], '#8888ff', new THREE.Vector3(0, 0, lenZ).add(axisOrigin), group, 'axis-label');

            const centerOffsetX = (C - 1) / 2;
            const centerOffsetY = -(B - 1) / 2;
            const centerOffsetZ = (A - 1) / 2;
            group.position.set(-centerOffsetX, -centerOffsetY, -centerOffsetZ);

            const wrapper = new THREE.Group();

            // Shift x by 2.5 so the 6 items (0 to 5) are centered around 0
            const worldPosX = (pos.x - 2.5) * spacingX; 
            const worldPosZ = 0; 

            wrapper.position.set(worldPosX, 0, worldPosZ);
            wrapper.add(group);
            scene.add(wrapper);

            const titleName = name === 'K' ? 'K^T' : name;
            addTrackingLabel(`${titleName} ${JSON.stringify(data.shape)}`, '#' + data.color.toString(16).padStart(6, '0'), new THREE.Vector3(0, B/2 + 1.5, 0), wrapper, 'tensor-label');
        }

        // Pull camera back to see the wider linear layout
        camera.position.set(0, spacingZ * 1.5, spacingX * 4.0);
        controls.target.set(0, 0, 0);

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            const vector = new THREE.Vector3();
            for(const marker of labelMarkers) {
                marker.obj.getWorldPosition(vector);
                vector.project(camera);

                if(vector.z < 1) {
                    const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                    const y = (-(vector.y * 0.5) + 0.5) * window.innerHeight;
                    marker.element.style.transform = `translate(-50%, -50%) translate(${x}px,${y}px)`;
                    marker.element.style.opacity = "1";
                } else {
                    marker.element.style.opacity = "0";
                }
            }

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>